<%# Upload form for loan documents %>

<%= render DS::Dialog.new do |dialog| %>
  <% dialog.with_header(title: "Import Loan from Document") %>
  <% dialog.with_body do %>
    <div class="space-y-6">
      <div class="text-center p-6 bg-container-inset rounded-lg">
        <%= lucide_icon "file-scan", class: "w-12 h-12 mx-auto text-secondary mb-3" %>
        <h3 class="text-lg font-medium text-primary mb-2">AI-Powered Loan Import</h3>
        <p class="text-sm text-secondary">
          Upload your loan document (sanction letter, statement, or screenshot) and our AI will automatically extract the loan details.
        </p>
      </div>

      <%= form_with model: @import, url: loan_document_imports_path, class: "space-y-4 relative", data: { turbo: false, controller: "form-submit", action: "submit->form-submit#submit" } do |f| %>
        <!-- Processing Overlay -->
        <div id="processing-overlay" class="hidden absolute inset-0 bg-white/90 dark:bg-gray-900/90 z-50 flex flex-col items-center justify-center rounded-lg backdrop-blur-sm">
          <div class="animate-spin rounded-full h-12 w-12 border-4 border-accent border-r-transparent mb-4"></div>
          <h3 class="text-lg font-medium text-primary">Analyzing Document...</h3>
          <p class="text-sm text-secondary mt-1">Extracting loan details with Gemini AI</p>
        </div>

        <div class="form-field">
          <label class="form-field__label">Loan Documents</label>
          <div class="mt-2">
            <%= f.file_field :documents, 
                multiple: true,
                accept: ".pdf,.png,.jpg,.jpeg,.webp",
                class: "block w-full text-sm text-primary
                        file:mr-4 file:py-2 file:px-4
                        file:rounded-lg file:border-0
                        file:text-sm file:font-medium
                        file:bg-blue-50 file:text-blue-700
                        hover:file:bg-blue-100
                        cursor-pointer" %>
          </div>
          <p class="text-xs text-secondary mt-1">Supported formats: PDF, PNG, JPG, JPEG, WebP. You can select multiple files!</p>
        </div>

        <div class="bg-blue-50 dark:bg-blue-900/30 border border-blue-200 dark:border-blue-800 rounded-lg p-4">
          <div class="flex items-start gap-3">
            <%= lucide_icon "info", class: "w-5 h-5 text-blue-600 dark:text-blue-400 shrink-0 mt-0.5" %>
            <div class="text-sm text-blue-800 dark:text-blue-200">
              <p class="font-medium mb-1">üìÅ Upload Multiple Documents for Better Accuracy!</p>
              <ul class="list-disc list-inside text-xs space-y-1">
                <li>Loan sanction letters (principal, rate, tenure)</li>
                <li>Quarterly/monthly statements (current balance)</li>
                <li>EMI schedule / Amortization table (full payment history)</li>
                <li>Screenshots from banking apps</li>
              </ul>
              <p class="text-xs mt-2 text-blue-600 dark:text-blue-300">üí° Tip: Upload both your amortization schedule AND latest statement together for complete loan data!</p>
            </div>
          </div>
        </div>

        <div class="flex justify-end gap-3 pt-4 border-t border-container">
          <%= link_to "Cancel", new_loan_path, class: "px-4 py-2 text-sm font-medium text-secondary hover:text-primary transition-colors" %>
          <%= f.submit "Upload & Analyze", class: "px-4 py-2 bg-accent text-white text-sm font-medium rounded-lg hover:bg-accent/90 focus:outline-none focus:ring-2 focus:ring-accent focus:ring-offset-2 cursor-pointer" %>
        </div>
      <% end %>

      <script>
        // Simple inline controller to handle loading state
        document.querySelector('form[data-controller="form-submit"]').addEventListener('submit', function(e) {
          const overlay = document.getElementById('processing-overlay');
          const btn = this.querySelector('input[type="submit"]');
          
          if (overlay) {
            overlay.classList.remove('hidden');
            if (btn) btn.disabled = true;
          }
        });
      </script>
    </div>
  <% end %>
<% end %>
